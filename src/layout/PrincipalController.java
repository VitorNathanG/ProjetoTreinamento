package layout;

import classes.DataHandler;
import classes.Espaco;
import classes.FileHandler;
import classes.Pessoa;
import javafx.beans.property.IntegerProperty;
import javafx.beans.property.SimpleIntegerProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.fxml.FXML;
import javafx.fxml.FXMLLoader;
import javafx.fxml.Initializable;
import javafx.geometry.Pos;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.control.cell.PropertyValueFactory;
import javafx.scene.control.cell.TextFieldTableCell;
import javafx.scene.layout.AnchorPane;
import javafx.scene.layout.Region;
import javafx.scene.layout.VBox;
import javafx.stage.Modality;
import javafx.stage.Stage;
import javafx.util.StringConverter;

import java.io.File;
import java.io.IOException;
import java.net.URL;
import java.util.*;

public class PrincipalController implements Initializable {

    @FXML private AnchorPane janela;

    @FXML private MenuBar barraDeMenu;
    @FXML private MenuItem salvarDadosMenuItem;
    @FXML private MenuItem sairSemSalvarMenuItem;
    @FXML private MenuItem salvarESairMenuItem;
    @FXML private MenuItem fazerBackupMenuItem;
    @FXML private MenuItem recuperarBackupMenuItem;
    @FXML private MenuItem abrirReadmeMenuItem;

    @FXML private Button mudarParaSalas;
    @FXML private Button mudarParaParticipantes;
    @FXML private Button mudarParaEspacosCafe;

    @FXML private AnchorPane anchorPaneTabelas;

    @FXML private TableView<Pessoa> tabelaParticipantes;
    @FXML private TableColumn<Pessoa, String> colunaNome;
    @FXML private TableColumn<Pessoa, String> colunaSobrenome;

    @FXML private TableView<Espaco> tabelaSalas;
    @FXML private TableColumn<Espaco, String> colunaIdentificacaoSala;
    @FXML private TableColumn<Espaco, Integer> colunaLotacaoSala;

    @FXML private TableView<Espaco> tabelaEspacosCafe;
    @FXML private TableColumn<Espaco, String> colunaIdentificacaoEspacosCafe;
    @FXML private TableColumn<Espaco, Integer> colunaLotacaoEspacosCafe;

    @FXML private AnchorPane adicionarParticipantePainel;
    @FXML private TextField adicionarParticipanteNome;
    @FXML private Button adicionarParticipanteBotao;
    @FXML private Label adicionarParticipanteLabel;

    @FXML private AnchorPane adicionarSalaPainel;
    @FXML private TextField adicionarSalaNome;
    @FXML private TextField adicionarSalaLotacao;
    @FXML private Button adicionarSalaBotao;
    @FXML private Label adicionarSalaLabel;

    @FXML private AnchorPane adicionarEspacoCafePainel;
    @FXML private TextField adicionarEspacoCafeNome;
    @FXML private TextField adicionarEspacoCafeLotacao;
    @FXML private Button adicionarEspacoCafeBotao;
    @FXML private Label adicionarEspacoCafeLabel;

    @FXML private Button botaoAbrirDetalhesParticipante;
    @FXML private Button botaoExcluirParticipante;

    @FXML private Button botaoAbrirDetalhesSala;
    @FXML private Button botaoExcluirSala;

    @FXML private Button botaoAbrirDetalhesEspacoCafe;
    @FXML private Button botaoExcluirEspacoCafe;

    private File infoEspacosCafe = FileHandler.criarArquivo("dados\\InfoEspacosCafe.data");
    private ObservableList<Espaco> espacosCafe = DataHandler.gerarEspacos(DataHandler.recuperarDadosSalvos(infoEspacosCafe));

    private File infoSalasTreinamento = FileHandler.criarArquivo("dados\\InfoSalasTreinamento.data");
    private ObservableList<Espaco> salasTreinamento = DataHandler.gerarEspacos(DataHandler.recuperarDadosSalvos(infoSalasTreinamento));

    private File infoPessoas = FileHandler.criarArquivo("dados\\InfoPessoas.data");
    private ObservableList<Pessoa> pessoas = DataHandler.gerarPessoas(DataHandler.recuperarDadosSalvos(infoPessoas));

    private StringConverter<Integer> conversor = new StringConverter<Integer>() {
        @Override
        public String toString(Integer object) {
            return object.toString();
        }

        @Override
        public Integer fromString(String string) {
            return Integer.parseInt(string);
        }
    };

    public static IntegerProperty salvarAoSair = new SimpleIntegerProperty();
    private static boolean modificacoesRealizadas;
    private static Region[] elementosOcultaveis;
    private static Pessoa pessoaSelecionada;
    private static Espaco espacoCafeSelecionado;
    private static Espaco espacoTreinamentoSelecionado;
    public static int capacidadeSalas;
    public static int capacidadeEspacosCafe;

    public int atualizarCapacidadeSalas() {
        capacidadeSalas = 0;
        for (Espaco salaTreinamento: salasTreinamento) {
            capacidadeSalas += salaTreinamento.getLotacao();
        }
        return PrincipalController.capacidadeSalas;
    }

    public int atualizarCapacidadeEspacosCafe() {
        capacidadeEspacosCafe = 0;
        for (Espaco salaTreinamento: espacosCafe) {
            capacidadeEspacosCafe += salaTreinamento.getLotacao();
        }
        return PrincipalController.capacidadeEspacosCafe;
    }

    public static boolean isModificacoesRealizadas() {
        return modificacoesRealizadas;
    }

    public static void setModificacoesRealizadas(boolean modificacoesRealizadas) {
        PrincipalController.modificacoesRealizadas = modificacoesRealizadas;
    }

    public static Pessoa getPessoaSelecionada() {
        return pessoaSelecionada;
    }

    public static void setPessoaSelecionada(Pessoa pessoaSelecionada) {
        PrincipalController.pessoaSelecionada = pessoaSelecionada;
    }

    public static Espaco getEspacoCafeSelecionado() {
        return espacoCafeSelecionado;
    }

    public static void setEspacoCafeSelecionado(Espaco espacoCafe) {
        PrincipalController.espacoCafeSelecionado = espacoCafe;
    }

    public static Espaco getEspacoTreinamentoSelecionado() {
        return espacoTreinamentoSelecionado;
    }

    public static void setEspacoTreinamentoSelecionado(Espaco espacoTreinamentoSelecionado) {
        PrincipalController.espacoTreinamentoSelecionado = espacoTreinamentoSelecionado;
    }

    public void fazerBackupMenuClicked(){
        DataHandler.salvarDados(FileHandler.criarArquivo("backup\\InfoPessoas.bkp"), pessoas, new Pessoa());
        DataHandler.salvarDados(FileHandler.criarArquivo("backup\\InfoEspacosCafe.bkp"), espacosCafe, new Espaco());
        DataHandler.salvarDados(FileHandler.criarArquivo("backup\\InfoSalasTreinamento.bkp"), salasTreinamento, new Espaco());
        emitirAlertBox("Backup", "O backup foi realizado com sucesso");
    }

    public void recuperarBackupMenuClicked() {
        File infoEspacosCafeBackup = new File("backup\\InfoEspacosCafe.bkp");
        File infoPessoasBackup = new File("backup\\InfoPessoas.bkp");
        File infoSalasTreinamentoBackup = new File("backup\\InfoSalasTreinamento.bkp");
        if (!infoEspacosCafeBackup.exists()||!infoPessoasBackup.exists()|| !infoSalasTreinamentoBackup.exists()) {
            emitirAlertBox("Recuperar Backup", "Os arquivos de backup est√£o incompletos");
        } else {
            espacosCafe = DataHandler.gerarEspacos(DataHandler.recuperarDadosSalvos(infoEspacosCafeBackup));
            pessoas = DataHandler.gerarPessoas(DataHandler.recuperarDadosSalvos(infoPessoasBackup));
            salasTreinamento = DataHandler.gerarEspacos(DataHandler.recuperarDadosSalvos(infoSalasTreinamentoBackup));
            definirTabelas();
            emitirAlertBox("Recuperar Backup", "O backup foi recuperado");
        }
    }

    @Override
    public void initialize(URL location, ResourceBundle resources){

        atualizarCapacidadeEspacosCafe();
        atualizarCapacidadeSalas();
        definirElementosOcultaveis();
        esmaecerBotoes();
        janelasReativas();
        popularSalas();
        definirTabelas();
        definirVisibilidadeInicial();
        criarOpcoesDeSaida();

    }

    private void popularSalas() {
        for (Pessoa pessoa: pessoas) {
            for (Espaco salaPrimeiraEtapa: salasTreinamento) {
                if(pessoa.getEspacoPrimeiraEtapa().equals(salaPrimeiraEtapa.getNomeEspaco())){
                    salaPrimeiraEtapa.adicionarIntegrantesPrimeiraEtapa(pessoa);
                    break;
                }
            }
            for (Espaco salaSegundaEtapa: salasTreinamento) {
                if(pessoa.getEspacoSegundaEtapa().equals(salaSegundaEtapa.getNomeEspaco())){
                    salaSegundaEtapa.adicionarIntegrantesSegundaEtapa(pessoa);
                    break;
                }
            }
            for (Espaco espacoCafePrimeiraEtapa: espacosCafe) {
                if(pessoa.getEspacoCafePrimeiraEtapa().equals(espacoCafePrimeiraEtapa.getNomeEspaco())){
                    espacoCafePrimeiraEtapa.adicionarIntegrantesPrimeiraEtapa(pessoa);
                    break;
                }
            }
            for (Espaco espacoCafeSegundaEtapa: espacosCafe) {
                if(pessoa.getEspacoCafeSegundaEtapa().equals(espacoCafeSegundaEtapa.getNomeEspaco())){
                    espacoCafeSegundaEtapa.adicionarIntegrantesSegundaEtapa(pessoa);
                    break;
                }
            }
        }
    }

    private void ocultarElementos(Region[] elementosOcultaveis) {
        for (Region elemento: elementosOcultaveis) {
            elemento.setVisible(false);
        }
    }

    private void definirElementosOcultaveis() {
        elementosOcultaveis = new Region[12];
        elementosOcultaveis[0] = adicionarParticipantePainel;
        elementosOcultaveis[1] = tabelaParticipantes;
        elementosOcultaveis[2] = botaoExcluirParticipante;
        elementosOcultaveis[3] = botaoAbrirDetalhesParticipante;
        elementosOcultaveis[4] = tabelaSalas;
        elementosOcultaveis[5] = adicionarSalaPainel;
        elementosOcultaveis[6] = botaoAbrirDetalhesSala;
        elementosOcultaveis[7] = botaoExcluirSala;
        elementosOcultaveis[8] = tabelaEspacosCafe;
        elementosOcultaveis[9] = adicionarEspacoCafePainel;
        elementosOcultaveis[10] = botaoAbrirDetalhesEspacoCafe;
        elementosOcultaveis[11] = botaoExcluirEspacoCafe;
    }

    public void adicionarParticipanteBotaoClicked() {
        if (adicionarParticipanteNome.getText().length() < 5) {
            emitirAlertBox("Nome", "O nome inserido √© muito curto");
        } else if (adicionarParticipanteNome.getText().contains("$")){
            emitirAlertBox("Caractere Inv√°lido", "O caractere $ n√£o √© valido");
        } else if (pessoas.size() > capacidadeEspacosCafe || pessoas.size() > capacidadeSalas){
            emitirAlertBox("Baixa capacidade", "O evento n√£o comporta mais participantes." + FileHandler.ENTER +
                    "Aumente a lota√ß√£o de salas e espa√ßos de caf√©");
        } else {

            String pessoaNome = Pessoa.separarNome(adicionarParticipanteNome.getText());
            String pessoaSobrenome = Pessoa.separarSobrenome(adicionarParticipanteNome.getText());
            String salaPrimeiraEtapa = getNextEspacoPrimeiraEtapa(salasTreinamento).getNomeEspaco();
            String salaSegundaEtapa = getNextEspacoSegundaEtapa(salasTreinamento).getNomeEspaco();
            String espacoCafePrimeiraEtapa = getNextEspacoPrimeiraEtapa(espacosCafe).getNomeEspaco();
            String espacoCafeSegundaEtapa = getNextEspacoSegundaEtapa(espacosCafe).getNomeEspaco();

            Pessoa novaPessoa = new Pessoa(pessoaNome, pessoaSobrenome, salaPrimeiraEtapa, salaSegundaEtapa,
                    espacoCafePrimeiraEtapa, espacoCafeSegundaEtapa);

            getNextEspacoPrimeiraEtapa(salasTreinamento).adicionarIntegrantesPrimeiraEtapa(novaPessoa);
            getNextEspacoSegundaEtapa(salasTreinamento).adicionarIntegrantesSegundaEtapa(novaPessoa);
            getNextEspacoPrimeiraEtapa(espacosCafe).adicionarIntegrantesPrimeiraEtapa(novaPessoa);
            getNextEspacoSegundaEtapa(espacosCafe).adicionarIntegrantesSegundaEtapa(novaPessoa);

            pessoas.add(novaPessoa);
            System.out.println(novaPessoa.toString());

            adicionarParticipanteNome.setText("");
            setModificacoesRealizadas(true);
            redistribuirSalasTreinamento();
            System.out.println(novaPessoa.toString());
            redistribuirEspacosCafeTreinamento();
            System.out.println(novaPessoa.toString());
        }
    }

    public void adicionarSalaBotaoClicked() {
        try {
            if (Integer.parseInt(adicionarSalaLotacao.getText()) < 1){
                throw new NumberFormatException();
            } else if (adicionarSalaNome.getText().contains("$")){
                emitirAlertBox("Erro","O caractere $ n√£o √© v√°lido");
            } else if (adicionarSalaNome.getText().length() < 1) {
                emitirAlertBox("Adicionar Nome da Sala", "Digite um valor no local indicado");
            } else {
                salasTreinamento.add(new Espaco(adicionarSalaNome.getText(), Integer.parseInt(adicionarSalaLotacao.getText())));
                adicionarSalaNome.setText("");
                adicionarSalaLotacao.setText("");
                setModificacoesRealizadas(true);
                atualizarCapacidadeSalas();
                redistribuirSalasTreinamento();
            }
        } catch (NumberFormatException e) {
            emitirAlertBox("Erro na lota√ß√£o", "Verifique o valor da lota√ß√£o");
        }
    }

    public void adicionarEspacoCafeBotaoClicked() {

        try {
            if (Integer.parseInt(adicionarEspacoCafeLotacao.getText()) < 1){
                throw new NumberFormatException();
            } else if (adicionarEspacoCafeNome.getText().contains("$")){
                emitirAlertBox("Erro","O caractere $ n√£o √© v√°lido");
            } else if (adicionarEspacoCafeNome.getText().length() < 1) {
                emitirAlertBox("Adicionar Nome do Espa√ßos", "Digite um valor no local indicado");
            } else {
                espacosCafe.add(new Espaco(adicionarEspacoCafeNome.getText(), Integer.parseInt(adicionarEspacoCafeLotacao.getText())));
                adicionarEspacoCafeNome.setText("");
                adicionarEspacoCafeLotacao.setText("");
                setModificacoesRealizadas(true);
                atualizarCapacidadeEspacosCafe();
                redistribuirEspacosCafeTreinamento();
            }
        } catch (NumberFormatException e) {
            emitirAlertBox("Erro na lota√ß√£o", "Verifique o valor da lota√ß√£o");
        }
    }

    public void botaoExcluirParticipanteClicked(){
        Pessoa pessoa = tabelaParticipantes.getSelectionModel().getSelectedItem();

        for (Espaco salaPrimeiraEtapa: salasTreinamento) {
            if(pessoa.getEspacoPrimeiraEtapa().equals(salaPrimeiraEtapa.getNomeEspaco())){
                salaPrimeiraEtapa.removerIntegrantesPrimeiraEtapa(pessoa);
                break;
            }
        }
        for (Espaco salaSegundaEtapa: salasTreinamento) {
            if(pessoa.getEspacoSegundaEtapa().equals(salaSegundaEtapa.getNomeEspaco())){
                salaSegundaEtapa.removerIntegrantesSegundaEtapa(pessoa);
                break;
            }
        }
        for (Espaco espacoCafePrimeiraEtapa: espacosCafe) {
            if(pessoa.getEspacoCafePrimeiraEtapa().equals(espacoCafePrimeiraEtapa.getNomeEspaco())){
                espacoCafePrimeiraEtapa.removerIntegrantesPrimeiraEtapa(pessoa);
                break;
            }
        }
        for (Espaco espacoCafeSegundaEtapa: espacosCafe) {
            if(pessoa.getEspacoCafeSegundaEtapa().equals(espacoCafeSegundaEtapa.getNomeEspaco())){
                espacoCafeSegundaEtapa.removerIntegrantesSegundaEtapa(pessoa);
                break;
            }
        }

        /*
         * As 8 linhas abaixo fazem exatamente o mesmo que pessoas.remove(pessoa), mas por algum
         * motivo, esse m√©todo quebra o ObservableList pessoas completamente
         */
        ObservableList<Pessoa> novasPessoas = FXCollections.observableArrayList();
        for (Pessoa pessoaSubstituta: pessoas) {
            if(!pessoaSubstituta.equals(pessoa)){
                novasPessoas.add(pessoaSubstituta);
            }
        }
        pessoas = FXCollections.observableArrayList();
        pessoas.addAll(novasPessoas);
        definirTabelas();
        setModificacoesRealizadas(true);
        redistribuirSalasTreinamento();
        redistribuirEspacosCafeTreinamento();
    }

    public void botaoExcluirSalaClicked(){
        Espaco selecionado = tabelaSalas.getSelectionModel().getSelectedItem();

        if (pessoas.size() != 0 && capacidadeSalas - selecionado.getLotacao() < pessoas.size()) {
            emitirAlertBox("Lota√ß√£o insuficiente", "N√£o √© poss√≠vel excluir, capacidade do evento insuficiente");
        } else if (salasTreinamento.size() == 2) {
            tabelaSalas.getItems().removeAll(selecionado);
            salasTreinamento.remove(selecionado);
            Espaco remanescente = tabelaSalas.getItems().get(0);
            remanescente.setIntegrantesSegundaEtapa(new ArrayList<>());
            remanescente.setIntegrantesPrimeiraEtapa(new ArrayList<>());
            for (Pessoa participante: pessoas) {

                participante.setEspacoPrimeiraEtapa(selecionado.getNomeEspaco());
                participante.setEspacoSegundaEtapa(selecionado.getNomeEspaco());
                remanescente.adicionarIntegrantesPrimeiraEtapa(participante);
                remanescente.adicionarIntegrantesSegundaEtapa(participante);
            }
        } else {
            tabelaSalas.getItems().removeAll(selecionado);
            salasTreinamento.remove(selecionado);
            redistribuirSalasTreinamento();
            definirTabelas();
            atualizarCapacidadeSalas();
            setModificacoesRealizadas(true);
        }
    }

    public void botaoExcluirEspacoCafeClicked(){
        Espaco selecionado = tabelaEspacosCafe.getSelectionModel().getSelectedItem();
        if(capacidadeEspacosCafe - selecionado.getLotacao() < pessoas.size()) {
            emitirAlertBox("Lota√ß√£o insuficiente", "N√£o √© poss√≠vel excluir, capacidade do evento insuficiente");
        } else {
            tabelaEspacosCafe.getItems().removeAll(selecionado);
            espacosCafe.remove(selecionado);
            redistribuirEspacosCafeTreinamento();
            definirTabelas();
            atualizarCapacidadeEspacosCafe();
            setModificacoesRealizadas(true);
        }
    }

    public void botaoAbrirDetalhesParticipanteClicked(){
        pessoaSelecionada = tabelaParticipantes.getSelectionModel().getSelectedItem();
        try {
            Parent root = FXMLLoader.load(getClass().getResource("informacaoparticipante.fxml"));

            Scene cena = new Scene(root);
            Stage palco = new Stage();
            palco.setScene(cena);
            palco.setResizable(false);
            palco.initModality(Modality.APPLICATION_MODAL);
            palco.show();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void botaoAbrirDetalhesSalaClicked(){
        espacoTreinamentoSelecionado = tabelaSalas.getSelectionModel().getSelectedItem();
        try {
            Parent root = FXMLLoader.load(getClass().getResource("informacaosala.fxml"));

            Scene cena = new Scene(root);
            Stage palco = new Stage();
            palco.setScene(cena);
            palco.setResizable(false);
            palco.initModality(Modality.APPLICATION_MODAL);
            palco.show();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void botaoAbrirDetalhesEspacoCafeClicked(){
        espacoCafeSelecionado = tabelaEspacosCafe.getSelectionModel().getSelectedItem();
        try {
            Parent root = FXMLLoader.load(getClass().getResource("informacaoespacocafe.fxml"));

            Scene cena = new Scene(root);
            Stage palco = new Stage();
            palco.setScene(cena);
            palco.setResizable(false);
            palco.initModality(Modality.APPLICATION_MODAL);
            palco.show();

        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public void mudarParaParticipantesClicked() {
        ocultarElementos(elementosOcultaveis);
        adicionarParticipantePainel.setVisible(true);
        tabelaParticipantes.setVisible(true);
        botaoExcluirParticipante.setVisible(true);
        botaoAbrirDetalhesParticipante.setVisible(true);
    }

    public void mudarParaSalasClicked() {
        ocultarElementos(elementosOcultaveis);

        tabelaSalas.setVisible(true);
        adicionarSalaPainel.setVisible(true);
        botaoAbrirDetalhesSala.setVisible(true);
        botaoExcluirSala.setVisible(true);
    }

    public void mudarParaEspacosCafeClicked() {

        ocultarElementos(elementosOcultaveis);

        tabelaEspacosCafe.setVisible(true);
        adicionarEspacoCafePainel.setVisible(true);
        botaoAbrirDetalhesEspacoCafe.setVisible(true);
        botaoExcluirEspacoCafe.setVisible(true);
    }

    public void definirVisibilidadeInicial(){
        ocultarElementos(elementosOcultaveis);

        adicionarParticipantePainel.setVisible(true);
        tabelaParticipantes.setVisible(true);
        botaoExcluirParticipante.setVisible(true);
        botaoAbrirDetalhesParticipante.setVisible(true);
    }

    public void janelasReativas(){
        janela.widthProperty().addListener((obs, oldVal, newVal) -> {
            tabelaParticipantes.setMaxWidth((Math.round((double) newVal)) - 180);
            tabelaParticipantes.setMinWidth((Math.round((double) newVal)) - 180);

            tabelaSalas.setMaxWidth((Math.round((double) newVal)) - 180);
            tabelaSalas.setMinWidth((Math.round((double) newVal)) - 180);

            tabelaParticipantes.setMaxWidth((Math.round((double) newVal)) - 180);
            tabelaParticipantes.setMinWidth((Math.round((double) newVal)) - 180);
        });

        tabelaParticipantes.widthProperty().addListener((obs, oldVal, newVal) -> {
            colunaSobrenome.setMaxWidth((Math.round((double) newVal)) - 250);
            colunaSobrenome.setMinWidth((Math.round((double) newVal)) - 250);
        });

        tabelaSalas.widthProperty().addListener((obs, oldVal, newVal) -> {
            colunaLotacaoSala.setMaxWidth((Math.round((double) newVal - 250)));
            colunaLotacaoSala.setMinWidth((Math.round((double) newVal - 250)));
        });

        tabelaEspacosCafe.widthProperty().addListener((obs, oldVal, newVal) -> {
            colunaLotacaoEspacosCafe.setMaxWidth((Math.round((double) newVal - 250)));
            colunaLotacaoEspacosCafe.setMinWidth((Math.round((double) newVal - 250)));
        });

        janela.heightProperty().addListener((obs, oldVal, newVal) -> {
            anchorPaneTabelas.setMaxHeight((Math.round((double) newVal)) - 80);
            anchorPaneTabelas.setMinHeight((Math.round((double) newVal)) - 80);
        });
    }

    public void definirTabelas(){
        colunaNome.setCellValueFactory(new PropertyValueFactory<>("nome"));
        colunaSobrenome.setCellValueFactory(new PropertyValueFactory<>("sobrenome"));

        colunaNome.setCellFactory(TextFieldTableCell.forTableColumn());
        colunaSobrenome.setCellFactory(TextFieldTableCell.forTableColumn());

        tabelaParticipantes.setItems(pessoas);

        colunaIdentificacaoSala.setCellValueFactory(new PropertyValueFactory<>("nomeEspaco"));
        colunaIdentificacaoSala.setCellFactory(TextFieldTableCell.forTableColumn());

        colunaLotacaoSala.setCellValueFactory(new PropertyValueFactory<Espaco, Integer>("lotacao"));
        colunaLotacaoSala.setCellFactory(TextFieldTableCell.forTableColumn(conversor));

        tabelaSalas.setItems(salasTreinamento);

        colunaIdentificacaoEspacosCafe.setCellValueFactory(new PropertyValueFactory<>("nomeEspaco"));
        colunaIdentificacaoEspacosCafe.setCellFactory(TextFieldTableCell.forTableColumn());

        colunaLotacaoEspacosCafe.setCellValueFactory(new PropertyValueFactory<Espaco, Integer>("lotacao"));
        colunaLotacaoEspacosCafe.setCellFactory(TextFieldTableCell.forTableColumn(conversor));

        tabelaEspacosCafe.setItems(espacosCafe);
    }

    private void esmaecerBotoes(){

        tabelaParticipantes.getSelectionModel().selectedItemProperty().addListener((obs, oldVal, newVal) -> {
            if(newVal != null) {
                botaoExcluirParticipante.setDisable(false);
                botaoAbrirDetalhesParticipante.setDisable(false);
            } else {
                botaoExcluirParticipante.setDisable(true);
                botaoAbrirDetalhesParticipante.setDisable(true);
            }
        });
        tabelaEspacosCafe.getSelectionModel().selectedItemProperty().addListener((obs, oldVal, newVal) -> {
            if(newVal != null) {
                botaoExcluirEspacoCafe.setDisable(false);
                botaoAbrirDetalhesEspacoCafe.setDisable(false);
            } else {
                botaoExcluirEspacoCafe.setDisable(true);
                botaoAbrirDetalhesEspacoCafe.setDisable(true);
            }
        });
        tabelaSalas.getSelectionModel().selectedItemProperty().addListener((obs, oldVal, newVal) -> {
            if(newVal != null) {
                botaoExcluirSala.setDisable(false);
                botaoAbrirDetalhesSala.setDisable(false);
            } else {
                botaoExcluirSala.setDisable(true);
                botaoAbrirDetalhesSala.setDisable(true);
            }
        });
    }

    public void salvarESair(){
        salvarDados();
        fecharPrograma();
    }

    public void sairSemSalvar(){
        fecharPrograma();
    }

    public void fecharPrograma(){
        Stage palco = (Stage) janela.getScene().getWindow();
        palco.close();
    }

    public void salvarDados(){
        DataHandler.salvarDados(infoPessoas, pessoas, new Pessoa());
        DataHandler.salvarDados(infoSalasTreinamento, salasTreinamento, new Espaco());
        DataHandler.salvarDados(infoEspacosCafe, espacosCafe, new Espaco());
        emitirAlertBox("Salvamento", "Os dados foram salvos");
        setModificacoesRealizadas(false);
    }

    private void criarOpcoesDeSaida(){
        salvarAoSair.addListener((observable, oldVal, newVal) -> {
            if(newVal.intValue()==1){
                salvarDados();
                fecharPrograma();
            } else if (newVal.intValue() == -1) {
                fecharPrograma();
            }
        });
    }

    public void emitirAlertBox(String titulo, String mensagem) {
        Stage palcoAlertBox = new Stage();
        palcoAlertBox.setTitle(titulo);
        Label texto = new Label(mensagem);
        Button botaoOk = new Button("Ok");
        botaoOk.setOnAction( e -> {
            palcoAlertBox.close();
        });
        VBox layout = new VBox(20);
        layout.getChildren().setAll(texto, botaoOk);
        layout.setAlignment(Pos.CENTER);
        layout.setPrefHeight(150);
        layout.setPrefWidth(300);
        Scene cena = new Scene(layout);
        palcoAlertBox.setResizable(false);
        palcoAlertBox.initModality(Modality.APPLICATION_MODAL);
        palcoAlertBox.setScene(cena);
        palcoAlertBox.sizeToScene();
        palcoAlertBox.show();
    }

    public Espaco getNextEspacoPrimeiraEtapa(ObservableList<Espaco> espacos){
        int menorLotacao = Integer.MAX_VALUE;
        Espaco retorno = new Espaco();
        for (Espaco espaco: espacos) {
            if(espaco.getIntegrantesPrimeiraEtapa().size() < menorLotacao){
                retorno = espaco;
                menorLotacao = espaco.getIntegrantesPrimeiraEtapa().size();
            }
        }
        return retorno;
    }

    public Espaco getNextEspacoSegundaEtapa(ObservableList<Espaco> espacos){
        int menorLotacao = Integer.MAX_VALUE;
        Espaco retorno = new Espaco();
        for (Espaco espaco: espacos) {
            if(espaco.getIntegrantesSegundaEtapa().size() < menorLotacao){
                retorno = espaco;
                menorLotacao = espaco.getIntegrantesSegundaEtapa().size();
            }
        }
        return retorno;
    }

    public void redistribuirEspacosCafeTreinamento(){
        Random gerador = new Random();

        for (Pessoa pessoa: pessoas) {
            pessoa.setEspacoCafePrimeiraEtapa("");
            pessoa.setEspacoCafeSegundaEtapa("");
        }
        for (Espaco espacoCafe: espacosCafe) {
            espacoCafe.setIntegrantesPrimeiraEtapa(new ArrayList<>());
            espacoCafe.setIntegrantesSegundaEtapa(new ArrayList<>());
        }

        /*
         * As linhas abaixo definem aleatoriamente as salas de treinamento e espacos de caf√© para
         * cada um dos participantes, mas n√£o fazem a troca de participantes entre a primeira e a segunda etapas
         */

        for (Pessoa pessoa: pessoas) {
            ArrayList<Espaco> cafes = getEspacosMaisVaziosPrimeiraEtapa(espacosCafe);
            Espaco cafe = cafes.get(gerador.nextInt(cafes.size()));

            pessoa.setEspacoCafePrimeiraEtapa(cafe.getNomeEspaco());
            pessoa.setEspacoCafeSegundaEtapa(cafe.getNomeEspaco());
            cafe.adicionarIntegrantesPrimeiraEtapa(pessoa);
            cafe.adicionarIntegrantesSegundaEtapa(pessoa);
        }

        ArrayList<Pessoa> pessoasQueMudamDeSala = new ArrayList<>();

        for (Espaco espaco : espacosCafe) {
            boolean selecionador = true;
            for (Pessoa participante: espaco.getIntegrantesSegundaEtapa()) {
                if (selecionador) {
                    espaco.removerIntegrantesSegundaEtapa(participante);
                    pessoasQueMudamDeSala.add(participante);
                    selecionador = false;
                } else {
                    selecionador = true;
                }
            }
        }

        for (Pessoa p: pessoasQueMudamDeSala) {
            p.setEspacoCafeSegundaEtapa("");
        }

        ArrayList<Espaco> espacosMaisCheios = getEspacosMaisCheiosSegundaEtapa(espacosCafe);
        int contadorPessoa = espacosCafe.indexOf(espacosMaisCheios.get(espacosMaisCheios.size()-1)); //PEGAR O ESPA√áO SEGUINTE AO MAIS CHEIO
        int contadorEspaco = 0;
        boolean rollOver1 = false;
        boolean rollOver2 = true;
        int valorEsperadoPorSala = getEspacosMaisCheiosPrimeiraEtapa(espacosCafe).get(0).getIntegrantesPrimeiraEtapa().size();

        ArrayList<Espaco> espacosNaoLotados = new ArrayList<>();
        espacosNaoLotados.addAll(espacosCafe);

        while (pessoasQueMudamDeSala.size() != 0) {
            if(espacosNaoLotados.size() == 1) {
                Espaco espaco = espacosCafe.get(espacosCafe.indexOf(espacosNaoLotados.get(0)));
                for (Pessoa p: pessoasQueMudamDeSala) {
                    p.setEspacoCafeSegundaEtapa(espaco.getNomeEspaco());
                    espaco.adicionarIntegrantesSegundaEtapa(p);
                    pessoasQueMudamDeSala.remove(pessoasQueMudamDeSala.indexOf(p));
                    rollOver1 = false;
                    rollOver2 = false;
                }
                break;
            }
            if(espacosCafe.get(contadorEspaco).getIntegrantesSegundaEtapa().size() == espacosCafe.get(contadorEspaco).getLotacao()){
                espacosNaoLotados.remove(espacosCafe.get(contadorEspaco));
                if (contadorEspaco >= espacosCafe.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                continue;
            }
            if (!pessoasQueMudamDeSala.get(contadorPessoa).getEspacoCafePrimeiraEtapa().equals(espacosCafe.get(contadorEspaco).getNomeEspaco()) &&
                    espacosCafe.get(contadorEspaco).getIntegrantesSegundaEtapa().size() < valorEsperadoPorSala){
                pessoasQueMudamDeSala.get(contadorPessoa).setEspacoCafeSegundaEtapa(espacosCafe.get(contadorEspaco).getNomeEspaco());
                espacosCafe.get(contadorEspaco).adicionarIntegrantesSegundaEtapa(pessoasQueMudamDeSala.get(contadorPessoa));
                pessoasQueMudamDeSala.remove(contadorPessoa);
                if (contadorEspaco >= espacosCafe.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                if (contadorPessoa >= pessoasQueMudamDeSala.size()-1){
                    contadorPessoa = 0;
                }
                continue;
            }
            if (rollOver2) {
                if (contadorEspaco >= espacosCafe.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                rollOver1 = false;
                rollOver2 = false;
            }
            if (contadorPessoa >= pessoasQueMudamDeSala.size()-1){
                contadorPessoa = 0;
                if (rollOver1) {
                    rollOver2 = true;
                }
                rollOver1 = true;
            } else {
                contadorPessoa++;
            }
        }
    }

    /**
     * Redistribui os participantes nas salas de treinamento
     *
     * Perigo: o m√©todo abaixo pode causar dor de cabe√ßa, ansiedade e desespero.
     */
    public void redistribuirSalasTreinamento(){
        /*
         * As linhas abaixo limpam as atuais defini√ß√µes de salas
         * Dificuldade: 1
         */
        Random gerador = new Random();

        Collections.shuffle(pessoas);

        for (Pessoa pessoa: pessoas) {
            pessoa.setEspacoPrimeiraEtapa("");
            pessoa.setEspacoSegundaEtapa("");
        }
        for (Espaco sala: salasTreinamento) {
            sala.setIntegrantesPrimeiraEtapa(new ArrayList<>());
            sala.setIntegrantesSegundaEtapa(new ArrayList<>());
        }

        /*
         * As linhas abaixo definem aleatoriamente as salas de treinamento para
         * cada um dos participantes, mas n√£o fazem a troca de participantes entre a primeira e a segunda etapas
         * Dificuldade: 3
         */

        for (Pessoa pessoa: pessoas) {
            ArrayList<Espaco> salas = getEspacosMaisVaziosPrimeiraEtapa(salasTreinamento);
            Espaco sala = salas.get(gerador.nextInt(salas.size()));

            pessoa.setEspacoPrimeiraEtapa(sala.getNomeEspaco());
            pessoa.setEspacoSegundaEtapa(sala.getNomeEspaco());
            sala.adicionarIntegrantesPrimeiraEtapa(pessoa);
            sala.adicionarIntegrantesSegundaEtapa(pessoa);
        }

        /*
         * As linhas abaixo definem quais participantes continuam na sala na segunda etapa
         * e quais pessoas v√£o para outras salas
         * Dificuldade: 4
         */

        ArrayList<Pessoa> pessoasQueMudamDeSala = new ArrayList<>();
        for (Espaco espaco : salasTreinamento) {
            boolean selecionador = true;
            for (Pessoa participante: espaco.getIntegrantesSegundaEtapa()) {
                if (selecionador) {
                    espaco.removerIntegrantesSegundaEtapa(participante);
                    pessoasQueMudamDeSala.add(participante);
                    selecionador = false;
                } else {
                    selecionador = true;
                }
            }
        }

        for (Pessoa p: pessoasQueMudamDeSala) {
            p.setEspacoSegundaEtapa("");
        }

        /*
         *     As linhas at√© o final do m√©todo s√£o respons√°veis por distribuir os participantes que
         * trocam de espa√ßo. Cada um deles √© destinado aleatoriamente para um espa√ßo que n√£o esteja cheio
         * ou que j√° tenha atingido o seu "valor esperado". A extens√£o e complexidade do m√©todo se devem
         * √†s condi√ß√µes propostas no problema:
         *
         *  1- Para estimular a troca de conhecimentos, metade das pessoas precisam trocar de sala entre
         *     as duas etapas do treinamento.
         *  2- A diferen√ßa de pessoas em cada sala dever√° ser de no m√°ximo 1 pessoa.
         *
         *     Como a implementa√ß√£o deste sistema leva em conta um n√∫mero arbitr√°rio de participantes, salas de
         * treinamento e espa√ßos de caf√©, delegar os participantes consistentemente para uma sala diferente da qual eles
         * realizaram a primeira parte do treinamento torna-se complicado.
         *     A situa√ß√£o √© agravada ao se considerar a segunda condi√ß√£o do problema. Tal condi√ß√£o torna muito complexo
         * o processo de corre√ß√£o de eventuais erros que os algoritmos usados para implementar a primeira parte
         * geram.
         *     As implementa√ß√µes anteriores que tentei aparentavam corrigir todos os problemas citados acima, por√©m,
         * em situa√ß√µes limite, falhavam e geravam anomalias na distribui√ß√£o. Uma grande quantidade de
         * testes seria necess√°ria para ter uma melhor avalia√ß√£o estat√≠stica da probabilidade de falha em situa√ß√µes
         * extremas (salas com tamanhos muito variados ou pr√≥ximas do limite de lota√ß√£o), algo que meu tempo dispon√≠vel
         * n√£o permitiria fazer.
         *     A implementa√ß√£o atual n√£o demonstrou nenhuma anomalia √†s regras de distribui√ß√£o. Mas, reiterando, √©
         * poss√≠vel que ocorra algum bug ou freeze durante a execu√ß√£o deste m√©todo, e uma implementa√ß√£o mais robusta
         * deveria ser aplicada para um software de uso comercial.
         *
         * *Coment√°rio de implementa√ß√£o por Vitor Nathan Gon√ßalves.
         */

        /*
         * As linhas abaixo definem alguns par√¢metros necess√°rios para definir os limites de lota√ß√£o e distribui√ß√£o dos
         * participantes. Destaque especial para os Booleanos rollOver: eles servem como sistema para evitar que o algoritmo
         * entre em softlock devido a uma tentativa de atribuir um participante ao mesmo espa√ßo que ele realizou a
         * primeira etapa do treinamento.
         */
        ArrayList<Espaco> espacosMaisCheios = getEspacosMaisCheiosSegundaEtapa(salasTreinamento);
        int contadorPessoa = 0;
        int contadorEspaco = salasTreinamento.indexOf(espacosMaisCheios.get(espacosMaisCheios.size()-1)); //PEGAR O ESPA√áO SEGUINTE AO MAIS CHEIO
        if (contadorEspaco == salasTreinamento.size()-1) { // Evita um IndexOutOfBounds caso todos os espa√ßos estejam com
            contadorEspaco = 0;                            // a mesma capacidade
        }
        boolean rollOver1 = false;
        boolean rollOver2 = true;
        int valorEsperadoPorSala = getEspacosMaisCheiosPrimeiraEtapa(salasTreinamento).get(0).getIntegrantesPrimeiraEtapa().size();
        int totalMaximosEsperados = getEspacosMaisCheiosPrimeiraEtapa(salasTreinamento).size();

        ArrayList<Espaco> espacosNaoLotados = new ArrayList<>();
        espacosNaoLotados.addAll(salasTreinamento);

        /*
         * In√≠cio do loop principal de distribui√ß√£o, s√≥ termina quando todos participantes tenham sido designados para
         * uma sala que atende aos crit√©rios. Um espa√ßo √© mantido fixo enquanto os participantes s√£o "ciclados" at√©
         * que um participante possa integrar o espa√ßo, respeitando os crit√©rios de distribui√ß√£o
         */
        while (pessoasQueMudamDeSala.size() != 0) {

            //Caso somente uma sala n√£o esteja lotada, atribui todos os participantes que restam √† ela
            if(espacosNaoLotados.size() == 1) {
                Espaco espaco = salasTreinamento.get(salasTreinamento.indexOf(espacosNaoLotados.get(0)));
                for (Pessoa p: pessoasQueMudamDeSala) {
                    p.setEspacoSegundaEtapa(espaco.getNomeEspaco());
                    espaco.adicionarIntegrantesSegundaEtapa(p);
                    pessoasQueMudamDeSala.remove(pessoasQueMudamDeSala.indexOf(p));
                }
                break;
            }
            //Capacidade m√°xima se refere √† popula√ß√£o das salas que possuem 1 participante a mais que as outras
            //Caso a sala esteja com sua capacidade m√°xima esperada, pula para a pr√≥xima sala
            if (salasTreinamento.get(contadorEspaco).getIntegrantesSegundaEtapa().size() == valorEsperadoPorSala) {
                if (contadorEspaco >= salasTreinamento.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                continue;
            }

            //Caso o limite de salas com a capacidade m√°xima seja alcan√ßado (as outras ter√£o capacidade m√°x. - 1)
            if (salasTreinamento.get(contadorEspaco).getIntegrantesSegundaEtapa().size() == valorEsperadoPorSala-1 && totalMaximosEsperados ==0) {
                if (contadorEspaco >= salasTreinamento.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                continue;
            }

            //Caso o espaco esteja lotado, pula para o pr√≥ximo espa√ßo
            if(salasTreinamento.get(contadorEspaco).getIntegrantesSegundaEtapa().size() == salasTreinamento.get(contadorEspaco).getLotacao()){
                espacosNaoLotados.remove(salasTreinamento.get(contadorEspaco));
                if (contadorEspaco >= salasTreinamento.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                continue;
            }

            //Caso seja poss√≠vel mudar a sala
            if (!pessoasQueMudamDeSala.get(contadorPessoa).getEspacoPrimeiraEtapa().equals(salasTreinamento.get(contadorEspaco).getNomeEspaco()) &&
                    salasTreinamento.get(contadorEspaco).getIntegrantesSegundaEtapa().size() < valorEsperadoPorSala){

                pessoasQueMudamDeSala.get(contadorPessoa).setEspacoSegundaEtapa(salasTreinamento.get(contadorEspaco).getNomeEspaco());
                salasTreinamento.get(contadorEspaco).adicionarIntegrantesSegundaEtapa(pessoasQueMudamDeSala.get(contadorPessoa));
                pessoasQueMudamDeSala.remove(contadorPessoa);

                //Reduz 1 no n√∫mero de salas que ainda podem ter 1 integrante a mais que as outras
                if (salasTreinamento.get(contadorEspaco).getIntegrantesSegundaEtapa().size() == valorEsperadoPorSala) {
                    totalMaximosEsperados--;
                }

                //Pula para o pr√≥ximo espa√ßo
                if (contadorEspaco >= salasTreinamento.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }

                //Pula para a pr√≥xima pessoa da lista
                if (contadorPessoa >= pessoasQueMudamDeSala.size()-1){
                    contadorPessoa = 0;
                }

                //Reseta os rollOvers, visto que n√£o houve necessidade de pular um espa√ßo indispon√≠vel
                rollOver1 = false;
                rollOver2 = false;
                continue;

            }
            //Atua√ß√£o do rollOver: todas pessoas foram testadas no espa√ßo e nenhuma pode ser atribuida a ele
            //Pula para o pr√≥ximo espa√ßo e reseta os rollovers
            if (rollOver2) {
                if (contadorEspaco >= salasTreinamento.size()-1){
                    contadorEspaco = 0;
                } else {
                    contadorEspaco++;
                }
                rollOver1 = false;
                rollOver2 = false;
            }
            //Caso nenhuma das op√ß√µes acima seja atendida, simplesmente pula para a pr√≥xima pessoa
            if (contadorPessoa >= pessoasQueMudamDeSala.size()-1){
                contadorPessoa = 0;
                if (rollOver1) {
                    rollOver2 = true;
                }
                rollOver1 = true;
            } else {
                contadorPessoa++;
            }
        }
    }

    public ArrayList<Espaco> getEspacosMaisVaziosPrimeiraEtapa(ObservableList<Espaco> espacos){
        int minimoPessoas = Integer.MAX_VALUE;
        ArrayList<Espaco> retorno = new ArrayList<>();
        for (Espaco espaco : espacos) {
            if (espaco.getLotacao() == espaco.getIntegrantesPrimeiraEtapa().size()){
                continue;
            }
            if (espaco.getIntegrantesPrimeiraEtapa().size() < minimoPessoas) {
                retorno = new ArrayList<>();
                retorno.add(espaco);
                minimoPessoas = espaco.getIntegrantesPrimeiraEtapa().size();
            } else if (espaco.getIntegrantesPrimeiraEtapa().size() == minimoPessoas) {
                retorno.add(espaco);
            }
        }
        return retorno;
    }

    public ArrayList<Espaco> getEspacosMaisVaziosSegundaEtapa(ObservableList<Espaco> espacos){
        int minimoPessoas = Integer.MAX_VALUE;
        ArrayList<Espaco> retorno = new ArrayList<>();
        for (Espaco espaco : espacos) {
            if(espaco.getLotacao() == espaco.getIntegrantesSegundaEtapa().size()) {
                continue;
            }
            if (espaco.getIntegrantesSegundaEtapa().size() < minimoPessoas) {
                retorno = new ArrayList<>();
                retorno.add(espaco);
                minimoPessoas = espaco.getIntegrantesSegundaEtapa().size();
            } else if (espaco.getIntegrantesSegundaEtapa().size() == minimoPessoas) {
                retorno.add(espaco);
            }
        }
        return retorno;
    }

    public ArrayList<Espaco> getEspacosMaisCheiosSegundaEtapa(ObservableList<Espaco> espacos){
        int maximoPessoas = Integer.MIN_VALUE;
        ArrayList<Espaco> retorno = new ArrayList<>();
        for (Espaco espaco : espacos) {
            if(espaco.getLotacao() == espaco.getIntegrantesSegundaEtapa().size()) {
                continue;
            }
            if (espaco.getIntegrantesSegundaEtapa().size() > maximoPessoas) {
                retorno = new ArrayList<>();
                retorno.add(espaco);
                maximoPessoas = espaco.getIntegrantesSegundaEtapa().size();
            } else if (espaco.getIntegrantesSegundaEtapa().size() == maximoPessoas) {
                retorno.add(espaco);
            }
        }
        return retorno;
    }

    public ArrayList<Espaco> getEspacosMaisCheiosPrimeiraEtapa(ObservableList<Espaco> espacos){
        int maximoPessoas = Integer.MIN_VALUE;
        ArrayList<Espaco> retorno = new ArrayList<>();
        for (Espaco espaco : espacos) {
            if(espaco.getLotacao() == espaco.getIntegrantesPrimeiraEtapa().size()) {
                continue;
            }
            if (espaco.getIntegrantesPrimeiraEtapa().size() > maximoPessoas) {
                retorno = new ArrayList<>();
                retorno.add(espaco);
                maximoPessoas = espaco.getIntegrantesPrimeiraEtapa().size();
            } else if (espaco.getIntegrantesPrimeiraEtapa().size() == maximoPessoas) {
                retorno.add(espaco);
            }
        }
        return retorno;
    }
}
